#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ API –§–ù–° —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–ª—é—á–æ–º
"""

import os
import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—è–º –ø—Ä–æ–µ–∫—Ç–∞
sys.path.insert(0, str(Path(__file__).parent.parent))

# ============================================
# –í–°–¢–ê–í–¨–¢–ï –í–ê–® –ö–õ–Æ–ß API –§–ù–° –ó–î–ï–°–¨!
# ============================================
YOUR_FNS_API_KEY = "–í–ê–®_–†–ï–ê–õ–¨–ù–´–ô_–ö–õ–Æ–ß_–§–ù–°_–ó–î–ï–°–¨"
# ============================================

def test_with_key():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–ª—é—á–æ–º"""
    
    print("üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –§–ù–° —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–ª—é—á–æ–º")
    print("=" * 60)
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª—é—á –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
    os.environ['FNS_API_KEY'] = YOUR_FNS_API_KEY
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á
    if not YOUR_FNS_API_KEY or YOUR_FNS_API_KEY == "–í–ê–®_–†–ï–ê–õ–¨–ù–´–ô_–ö–õ–Æ–ß_–§–ù–°_–ó–î–ï–°–¨":
        print("‚ùå –û–®–ò–ë–ö–ê: –í—ã –Ω–µ –≤—Å—Ç–∞–≤–∏–ª–∏ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á API –§–ù–°!")
        print("\n–ó–∞–º–µ–Ω—Ç–∏—Ç–µ '–í–ê–®_–†–ï–ê–õ–¨–ù–´–ô_–ö–õ–Æ–ß_–§–ù–°_–ó–î–ï–°–¨' –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á")
        print("–í–∞—à –∫–ª—é—á –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫: 1234567890abcdef")
        return False
    
    print(f"‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–ª—é—á: {YOUR_FNS_API_KEY[:10]}...")
    
    try:
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å
        from backend.services.fns_service import fns_service
        
        # –¢–µ—Å—Ç–æ–≤—ã–µ –ò–ù–ù (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ)
        test_inns = [
            "7707083893",  # –Ø–Ω–¥–µ–∫—Å (–ø—Ä–∏–º–µ—Ä)
            "3664069396",  # –°–±–µ—Ä–±–∞–Ω–∫ (–ø—Ä–∏–º–µ—Ä)
            "1234567890",  # –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
        ]
        
        print("\nüîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –ò–ù–ù:")
        print("-" * 60)
        
        for inn in test_inns:
            print(f"\n–ò–ù–ù: {inn}")
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
            is_valid, error = fns_service.validate_inn_format(inn)
            print(f"  –§–æ—Ä–º–∞—Ç: {'‚úÖ –í–∞–ª–∏–¥–µ–Ω' if is_valid else f'‚ùå {error}'}")
            
            if is_valid:
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API
                result = fns_service.check_inn(inn)
                
                if result["success"]:
                    data = result["data"]
                    print(f"  –°—Ç–∞—Ç—É—Å: ‚úÖ –£–°–ü–ï–•")
                    print(f"  –ù–∞–∑–≤–∞–Ω–∏–µ: {data.get('company_name') or data.get('full_name')}")
                    print(f"  –°—Ç–∞—Ç—É—Å –∫–æ–º–ø–∞–Ω–∏–∏: {data.get('status')}")
                    print(f"  –ê–∫—Ç–∏–≤–Ω–∞: {'‚úÖ –î–∞' if data.get('is_active') else '‚ùå –ù–µ—Ç'}")
                    print(f"  –ö—ç—à–∏—Ä–æ–≤–∞–Ω–æ: {'‚úÖ –î–∞' if result.get('cached') else '‚ùå –ù–µ—Ç'}")
                else:
                    print(f"  –°—Ç–∞—Ç—É—Å: ‚ùå –û–®–ò–ë–ö–ê")
                    print(f"  –ü—Ä–∏—á–∏–Ω–∞: {result.get('error')}")
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        stats = fns_service.get_usage_stats()
        print("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API:")
        print(f"  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è: {stats['used_today']}")
        print(f"  –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç: {stats['daily_limit']}")
        print(f"  –û—Å—Ç–∞–ª–æ—Å—å: {stats['remaining']}")
        
        print("\n" + "=" * 60)
        print("üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
        
        return True
        
    except Exception as e:
        print(f"\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {str(e)}")
        return False


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print("""
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë
    ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
    ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    API –§–ù–° –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    """)
    
    success = test_with_key()
    
    if success:
        print("\n‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!")
        print("\nüìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:")
        print("1. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–ª—é—á –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ")
        print("2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ")
        print("3. –ó–∞–º–µ–Ω–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ò–ù–ù –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ")
    else:
        print("\n‚ùå –¢–ï–°–¢–´ –ù–ï –ü–†–û–ô–î–ï–ù–´")
        print("\nüîß –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:")
        print("1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–∞ API –§–ù–°")
        print("2. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ –§–ù–°")
        print("3. –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º")


if __name__ == "__main__":
    main()
