#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ API Ð¤ÐÐ¡ Ð´Ð»Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°

echo "==========================================="
echo "ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ API Ð¤ÐÐ¡ Ð”Ð›Ð¯ Ð­ÐšÐžÐ¡Ð˜Ð¡Ð¢Ð•ÐœÐ«"
echo "==========================================="

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
mkdir -p logs

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» .env ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
if [ ! -f .env ]; then
    echo "Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ñ„Ð°Ð¹Ð» .env..."
    cat > .env << EOF
# ===========================================
# API Ð¤ÐÐ¡ ÐšÐ›Ð®Ð§ (Ð—ÐÐœÐ•ÐÐ˜Ð¢Ð• ÐÐ Ð’ÐÐ¨ Ð Ð•ÐÐ›Ð¬ÐÐ«Ð™ ÐšÐ›Ð®Ð§)
# ===========================================
FNS_API_KEY=Ð’ÐÐ¨_Ð Ð•ÐÐ›Ð¬ÐÐ«Ð™_ÐšÐ›Ð®Ð§_Ð¤ÐÐ¡_Ð—Ð”Ð•Ð¡Ð¬

# ===========================================
# ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜ Ð‘ÐÐ—Ð« Ð”ÐÐÐÐ«Ð¥
# ===========================================
DATABASE_URL=postgresql://haus_price_user:Ð¿Ð°Ñ€Ð¾Ð»ÑŒ@localhost/haus_price_db
REDIS_URL=redis://localhost:6379

# ===========================================
# ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜ ÐŸÐ Ð˜Ð›ÐžÐ–Ð•ÐÐ˜Ð¯
# ===========================================
DEBUG=False
FLASK_SECRET_KEY=$(openssl rand -hex 32)
DOMAIN=https://Ð´Ð¾Ð¼Ð°-Ñ†ÐµÐ½Ñ‹.Ñ€Ñ„

# ===========================================
# PROTALK Ð˜ TELEGRAM
# ===========================================
PROTALK_WEBHOOK_SECRET=$(openssl rand -hex 32)
TELEGRAM_BOT_TOKEN=Ð²Ð°Ñˆ_Ñ‚Ð¾ÐºÐµÐ½_Ð±Ð¾Ñ‚Ð°
EOF
    echo "âœ… Ð¤Ð°Ð¹Ð» .env ÑÐ¾Ð·Ð´Ð°Ð½"
else
    echo "â„¹ï¸ Ð¤Ð°Ð¹Ð» .env ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
fi

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ»ÑŽÑ‡ Ð² .env
if [ -f .env ]; then
    echo -n "Ð¥Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÐ»ÑŽÑ‡ API Ð¤ÐÐ¡? (y/n): "
    read update_key
    
    if [ "$update_key" = "y" ]; then
        echo -n "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ ÐºÐ»ÑŽÑ‡ API Ð¤ÐÐ¡: "
        read fns_key
        
        if [ ! -z "$fns_key" ]; then
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ»ÑŽÑ‡ Ð² .env
            sed -i "s|FNS_API_KEY=.*|FNS_API_KEY=$fns_key|" .env
            echo "âœ… ÐšÐ»ÑŽÑ‡ API Ð¤ÐÐ¡ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½"
        else
            echo "âŒ ÐšÐ»ÑŽÑ‡ Ð½Ðµ Ð²Ð²ÐµÐ´ÐµÐ½"
        fi
    fi
fi

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÑŽ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Python..."
pip install -r requirements.txt
pip install redis requests python-dotenv

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚
echo "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Ñ‚ÐµÑÑ‚ API Ð¤ÐÐ¡..."
python scripts/test_fns_with_key.py

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…
mkdir -p data/cache
mkdir -p data/logs

echo ""
echo "==========================================="
echo "ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐ!"
echo "==========================================="
echo ""
echo "ðŸ“‹ Ð§Ð¢Ðž Ð¡Ð”Ð•Ð›ÐÐÐž:"
echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½ Ñ„Ð°Ð¹Ð» .env (ÐµÑÐ»Ð¸ Ð½Ðµ Ð±Ñ‹Ð»Ð¾)"
echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Python"
echo "âœ… ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº API Ð¤ÐÐ¡"
echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ñ‹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…"
echo ""
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ:"
echo "python backend/app.py"
echo ""
echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ„Ð°Ð¹Ð» .env Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸:"
echo "1. FNS_API_KEY - Ð²Ð°Ñˆ ÐºÐ»ÑŽÑ‡ API Ð¤ÐÐ¡"
echo "2. DATABASE_URL - Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…"
echo "3. PROTALK_WEBHOOK_SECRET - ÑÐµÐºÑ€ÐµÑ‚ Ð´Ð»Ñ Ð²ÐµÐ±Ñ…ÑƒÐºÐ¾Ð²"
